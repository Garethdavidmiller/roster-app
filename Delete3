<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CEA Roster Calendar</title>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="Chiltern Railways CEA shift roster calendar for Marylebone Station">
    <meta name="theme-color" content="#001e3c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="CEA Roster">
    <link rel="manifest" href="manifest.json">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #001e3c 0%, #003d7a 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
        }

        .header {
            background: white;
            padding: 35px 40px;
            border-radius: 20px;
            box-shadow: 0 15px 40px rgba(0,0,0,0.25);
            margin-bottom: 25px;
            text-align: center;
        }

        .header h1 {
            color: #001e3c;
            font-size: 36px;
            margin-bottom: 10px;
            font-weight: 800;
            letter-spacing: -0.5px;
        }

        .header p {
            color: #666;
            font-size: 18px;
            font-weight: 500;
        }

        .controls {
            background: white;
            padding: 25px 30px;
            border-radius: 20px;
            box-shadow: 0 15px 40px rgba(0,0,0,0.25);
            margin-bottom: 25px;
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            align-items: center;
            justify-content: center;
        }

        .control-group {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
            justify-content: center;
        }

        .controls button {
            min-width: auto;
            white-space: nowrap;
        }

        .controls label {
            font-weight: 600;
            color: #333;
        }

        .controls select, .controls button {
            padding: 12px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 15px;
            cursor: pointer;
            background: white;
            font-family: inherit;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .controls select {
            text-align: center;
            text-align-last: center;
        }

        .controls select option {
            text-align: center;
        }

        .controls button {
            background: linear-gradient(135deg, #001e3c 0%, #003d7a 100%);
            color: white;
            border-color: #001e3c;
            box-shadow: 0 4px 12px rgba(0, 30, 60, 0.3);
        }

        .controls button:hover {
            background: linear-gradient(135deg, #00152a 0%, #002952 100%);
            border-color: #00152a;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 30, 60, 0.4);
        }

        .controls button:active {
            transform: translateY(0);
        }

        .controls button.today-btn {
            background: linear-gradient(135deg, #ffd700 0%, #ffb700 100%);
            color: #001e3c;
            border-color: #ffd700;
            font-weight: 800;
        }

        .controls button.today-btn:hover {
            background: linear-gradient(135deg, #ffed4e 0%, #ffd700 100%);
            border-color: #ffed4e;
        }

        .controls button.print-btn {
            background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
            color: white;
            border-color: #4caf50;
            font-weight: 700;
        }

        .controls button.print-btn:hover {
            background: linear-gradient(135deg, #45a049 0%, #388e3c 100%);
            border-color: #45a049;
        }

        .controls select:focus, .controls button:focus {
            outline: none;
            border-color: #001e3c;
        }

        .calendar-container {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 15px 40px rgba(0,0,0,0.25);
            margin-bottom: 25px;
            width: 100%;
            box-sizing: border-box;
        }

        .calendar-header {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 4px solid #001e3c;
            gap: 20px;
            flex-wrap: wrap;
        }

        .month-year {
            font-size: 32px;
            font-weight: 800;
            color: #001e3c;
            letter-spacing: -0.5px;
        }

        .week-info {
            font-size: 15px;
            color: white;
            background: linear-gradient(135deg, #001e3c 0%, #003d7a 100%);
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(0, 30, 60, 0.3);
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 12px;
            width: 100%;
        }

        .day-header {
            text-align: center;
            font-weight: 800;
            color: white;
            background: linear-gradient(135deg, #001e3c 0%, #003d7a 100%);
            padding: 18px 8px;
            font-size: 15px;
            border-radius: 10px;
            letter-spacing: 0.5px;
            box-shadow: 0 4px 12px rgba(0, 30, 60, 0.25);
        }

        .calendar-day {
            min-height: 120px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 12px;
            background: #fafafa;
            transition: all 0.3s ease;
            position: relative;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            text-align: center;
        }

        .calendar-day:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }

        .calendar-day.other-month {
            opacity: 0.3;
            background: #f5f5f5;
        }

        .calendar-day.today {
            border-color: #001e3c;
            border-width: 4px;
            background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
            box-shadow: 0 8px 24px rgba(255, 215, 0, 0.5), 0 0 0 2px #001e3c;
            transform: scale(1.02);
        }

        .calendar-day.today .day-number {
            color: #001e3c;
            font-weight: 900;
        }

        .calendar-day.bank-holiday::before {
            content: '‚≠ê';
            position: absolute;
            top: 3px;
            right: 3px;
            font-size: 12px;
            z-index: 10;
        }

        .calendar-day.payday::before {
            content: 'üí∑';
            position: absolute;
            top: 3px;
            left: 3px;
            font-size: 10px;
            z-index: 10;
        }

        .calendar-day.rest-day {
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            border-color: #4caf50;
        }

        .calendar-day.early-shift {
            background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
            border-color: #ff9800;
        }

        .calendar-day.late-shift {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border-color: #2196f3;
        }

        .calendar-day.spare-day {
            background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%);
            border-color: #9c27b0;
        }

        .day-number {
            font-weight: 800;
            font-size: 20px;
            color: #333;
            margin-bottom: 8px;
            text-align: center;
            width: 100%;
        }

        .calendar-day.other-month .day-number {
            color: #999;
        }

        .shift-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 800;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }

        .badge-rest {
            background: #4caf50;
            color: white;
        }

        .badge-early {
            background: #ff9800;
            color: white;
        }

        .badge-late {
            background: #2196f3;
            color: white;
        }

        .badge-spare {
            background: #9c27b0;
            color: white;
        }

        .shift-time {
            font-size: 15px;
            color: #333;
            font-weight: 700;
            line-height: 1.5;
            letter-spacing: 0.3px;
            text-align: center;
            width: 100%;
        }

        .legend {
            background: white;
            padding: 18px 25px;
            border-radius: 20px;
            box-shadow: 0 15px 40px rgba(0,0,0,0.25);
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            text-align: center;
        }

        .legend-title {
            font-size: 15px;
            font-weight: 800;
            color: #001e3c;
            width: 100%;
            text-align: center;
            margin-bottom: 5px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .legend-color {
            width: 24px;
            height: 24px;
            border-radius: 6px;
            border: 2px solid #333;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }

        .legend-text {
            font-size: 13px;
            color: #333;
            font-weight: 600;
        }
            font-weight: 600;
        }

        @media (max-width: 1024px) {
            .calendar-grid {
                gap: 8px;
            }
            
            .calendar-day {
                min-height: 100px;
                padding: 10px;
            }

            .shift-time {
                font-size: 13px;
            }

            .month-year {
                font-size: 26px;
            }

            .controls button {
                padding: 12px 16px;
                font-size: 13px;
            }

            .control-group {
                gap: 8px;
            }
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .container {
                width: 100%;
            }

            .header {
                padding: 20px;
            }

            .calendar-container {
                padding: 15px;
            }

            .calendar-header {
                flex-direction: column;
                gap: 10px;
                align-items: center;
                text-align: center;
            }

            .calendar-day {
                min-height: 80px;
                padding: 6px;
            }

            .day-header {
                font-size: 11px;
                padding: 10px 3px;
            }

            .month-year {
                font-size: 20px;
            }

            .header h1 {
                font-size: 24px;
            }

            .calendar-grid {
                gap: 4px;
            }

            .shift-time {
                font-size: 11px;
            }

            .day-number {
                font-size: 14px;
                margin-bottom: 4px;
            }

            .shift-badge {
                font-size: 8px;
                padding: 3px 8px;
                margin-bottom: 4px;
            }

            .controls {
                padding: 15px;
            }

            .controls button {
                padding: 8px 12px;
                font-size: 12px;
            }

            .control-group {
                gap: 6px;
            }

            .controls {
                gap: 10px;
            }

            .legend {
                padding: 20px 15px;
            }

            .legend-item {
                font-size: 13px;
            }
        }

        @media (max-width: 480px) {
            body {
                padding: 3px;
            }

            .calendar-container {
                padding: 6px;
                border-radius: 12px;
            }

            .header {
                padding: 12px;
                border-radius: 12px;
            }

            .controls {
                padding: 10px;
                border-radius: 12px;
            }

            .calendar-day {
                min-height: 70px;
                padding: 3px;
                border-radius: 6px;
                border-width: 1px;
                display: flex !important;
                flex-direction: column !important;
                align-items: center !important;
                justify-content: flex-start !important;
                text-align: center !important;
            }

            .calendar-day.today {
                border-width: 3px;
            }

            .day-header {
                font-size: 9px;
                padding: 6px 1px;
                border-radius: 6px;
            }

            .calendar-grid {
                gap: 2px;
            }

            .shift-time {
                font-size: 9px;
            }

            .day-number {
                font-size: 12px;
            }

            .shift-badge {
                font-size: 7px;
                padding: 2px 5px;
            }

            .legend {
                padding: 12px 8px;
            }

            .legend-item {
                font-size: 11px;
            }

            .legend-color {
                width: 20px;
                height: 20px;
            }
        }

        /* Print styles */
        @media print {
            @page {
                margin: 0.5cm; /* Slightly reduced to give more breathing room */
                size: auto;    /* Let the browser determine size based on content */
            }

            * {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
                box-sizing: border-box !important;
            }

            html {
                height: auto !important;
                width: 100% !important;
                overflow: visible !important;
            }

            body {
                background: white !important;
                padding: 0 !important;
                margin: 0 !important;
                width: 100% !important;
                height: auto !important;
                overflow: visible !important;
            }

            /* Force the body to ignore any phantom trailing whitespace */
            body::after {
                content: "";
                display: block;
                height: 0;
                clear: both;
            }

            .container {
                max-width: 100% !important;
                width: 100% !important;
                padding: 0 !important;
                margin: 0 !important;
                height: auto !important;
                border: none !important;
                page-break-after: avoid !important;
            }

            .controls {
                display: none !important;
                height: 0 !important;
                overflow: hidden !important;
                position: absolute !important;
                visibility: hidden !important;
            }

            #calendarDisplay {
                display: block !important;
                visibility: visible !important;
                opacity: 1 !important;
                position: relative !important;
                page-break-after: avoid !important;
                page-break-inside: avoid !important;
            }

            .header {
                box-shadow: none !important;
                border: 1px solid #001e3c !important;
                page-break-after: avoid !important;
                page-break-inside: avoid !important;
                margin: 0 0 8px 0 !important;
                padding: 8px !important;
            }

            .header h1 {
                font-size: 16px !important;
                margin: 0 !important;
                padding: 0 !important;
            }

            .header p {
                font-size: 10px !important;
                margin: 2px 0 0 0 !important;
                padding: 0 !important;
            }

            /* Add team member name for print */
            .header::after {
                content: "Team Member: " attr(data-member-name);
                display: block;
                font-size: 11px;
                font-weight: bold;
                color: #001e3c;
                margin-top: 4px;
            }

            .calendar-container {
                box-shadow: none !important;
                border: 1px solid #001e3c !important;
                page-break-inside: avoid !important;
                page-break-after: avoid !important;
                padding: 6px !important;
                margin: 0 0 8px 0 !important;
                display: block !important;
                visibility: visible !important;
                opacity: 1 !important;
                height: auto !important;
                width: 100% !important;
                overflow: visible !important;
            }

            .calendar-header {
                margin: 0 0 6px 0 !important;
                padding: 0 0 4px 0 !important;
                display: flex !important;
                visibility: visible !important;
                page-break-after: avoid !important;
            }

            .month-year {
                font-size: 14px !important;
                margin: 0 !important;
            }

            .week-info {
                font-size: 9px !important;
                padding: 3px 6px !important;
                background: #001e3c !important;
                margin: 0 !important;
            }

            .calendar-grid {
                display: grid !important;
                grid-template-columns: repeat(7, 1fr) !important;
                gap: 2px !important;
                page-break-inside: avoid !important;
                page-break-after: avoid !important;
                visibility: visible !important;
                opacity: 1 !important;
                width: 100% !important;
                margin: 0 !important;
            }

            .day-header {
                font-size: 7px !important;
                padding: 3px 1px !important;
                background: #001e3c !important;
                color: white !important;
                display: block !important;
                visibility: visible !important;
                margin: 0 !important;
            }

            .calendar-day {
                box-shadow: none !important;
                page-break-inside: avoid !important;
                min-height: 48px !important;
                max-height: 48px !important;
                height: 48px !important;
                padding: 2px !important;
                margin: 0 !important;
                display: flex !important;
                flex-direction: column !important;
                align-items: center !important;
                justify-content: center !important;
                visibility: visible !important;
                opacity: 1 !important;
                border: 1px solid #999 !important;
                overflow: hidden !important;
            }

            .calendar-day:hover {
                transform: none !important;
                box-shadow: none !important;
            }

            .calendar-day.other-month {
                opacity: 0.3 !important;
            }

            .calendar-day.today {
                border-color: #001e3c !important;
                border-width: 2px !important;
                background: #ffffcc !important;
                transform: none !important;
                box-shadow: none !important;
            }

            .day-number {
                font-size: 10px !important;
                font-weight: bold !important;
                display: block !important;
                visibility: visible !important;
                margin: 0 !important;
                padding: 0 !important;
            }

            .shift-badge {
                font-size: 6px !important;
                padding: 1px 3px !important;
                display: inline-block !important;
                visibility: visible !important;
                margin: 1px 0 !important;
            }

            .shift-time {
                font-size: 6px !important;
                display: block !important;
                visibility: visible !important;
                margin: 0 !important;
                padding: 0 !important;
            }

            /* The Legend: Since this is the LAST element, its bottom margin must be ZERO */
            .legend {
                box-shadow: none !important;
                border: 1px solid #001e3c !important;
                page-break-before: avoid !important;
                page-break-inside: avoid !important;
                padding: 6px !important;
                margin: 8px 0 0 0 !important; /* ONLY top margin - NO bottom margin */
            }

            .legend-title {
                font-size: 10px !important;
                margin: 0 0 4px 0 !important;
            }

            .legend-item {
                font-size: 8px !important;
                margin: 0 !important;
            }

            .legend-color {
                width: 12px !important;
                height: 12px !important;
            }

            /* Ensure gradient backgrounds print */
            .calendar-day.rest-day {
                background: #e8f5e9 !important;
            }

            .calendar-day.early-shift {
                background: #fff3e0 !important;
            }

            .calendar-day.late-shift {
                background: #e3f2fd !important;
            }

            .calendar-day.spare-day {
                background: #f3e5f5 !important;
            }

            .badge-rest {
                background: #4caf50 !important;
                color: white !important;
            }

            .badge-early {
                background: #ff9800 !important;
                color: white !important;
            }

            .badge-late {
                background: #2196f3 !important;
                color: white !important;
            }

            .badge-spare {
                background: #9c27b0 !important;
                color: white !important;
            }

            .calendar-day.bank-holiday::before {
                content: '‚≠ê' !important;
                position: absolute !important;
                top: 2px !important;
                right: 2px !important;
                font-size: 9px !important;
            }

            .calendar-day.payday::before {
                content: 'üí∑' !important;
                position: absolute !important;
                top: 2px !important;
                left: 2px !important;
                font-size: 8px !important;
            }

        }

        /* Landscape print orientation */
        @media print and (orientation: landscape) {
            @page {
                size: A4 landscape;
                margin: 1cm;
            }

            body {
                width: 100% !important;
                height: auto !important;
            }

            .calendar-day {
                min-height: 45px !important;
                max-height: 45px !important;
                height: 45px !important;
            }

            .day-number {
                font-size: 9px !important;
            }

            .shift-badge {
                font-size: 6px !important;
            }

            .shift-time {
                font-size: 7px !important;
            }

            .header h1 {
                font-size: 18px !important;
            }

            .month-year {
                font-size: 16px !important;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÑ CEA Roster Calendar</h1>
            <p>London Marylebone Station</p>
        </div>

        <div class="controls">
            <div class="control-group">
                <label for="teamMemberSelect">Team Member:</label>
                <select id="teamMemberSelect">
                    <!-- Options populated by JavaScript -->
                </select>
            </div>

            <div class="control-group">
                <button id="prevMonth">‚Üê Previous</button>
                <button id="todayBtn" class="today-btn">üìç Today</button>
                <button id="printBtn" class="print-btn">üñ®Ô∏è Print</button>
                <button id="nextMonth">Next ‚Üí</button>
            </div>
        </div>

        <div id="calendarDisplay"></div>

        <div class="legend">
            <div class="legend-title">üìÖ Shift Legend</div>
            <div class="legend-item">
                <div class="legend-color" style="background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); border-color: #4caf50;"></div>
                <span class="legend-text">üè† Rest Day</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%); border-color: #ff9800;"></div>
                <span class="legend-text">‚òÄÔ∏è Early Shift</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); border-color: #2196f3;"></div>
                <span class="legend-text">üåô Late Shift</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%); border-color: #9c27b0;"></div>
                <span class="legend-text">üìã Spare</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%); border-color: #001e3c; border-width: 3px;"></div>
                <span class="legend-text">üìç Today</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: white; border-color: #333; position: relative;">
                    <span style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 14px;">‚≠ê</span>
                </div>
                <span class="legend-text">‚≠ê Bank Holiday</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: white; border-color: #333; position: relative;">
                    <span style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 14px;">üí∑</span>
                </div>
                <span class="legend-text">üí∑ Payday</span>
            </div>
        </div>
    </div>

    <script>
        // Team members with their current week assignments (as of Feb 8, 2026)
        const teamMembers = [
            { name: 'L. Springer', currentWeek: 1 },
            { name: 'A. Hared', currentWeek: 2 },
            { name: 'G. Miller', currentWeek: 3 },
            { name: 'M. Robson', currentWeek: 4 },
            { name: 'C. Matthews', currentWeek: 5 },
            { name: 'I. Cooper', currentWeek: 6 },
            { name: 'A. Panchal', currentWeek: 7 },
            { name: 'C. Francisco-Charles', currentWeek: 8 },
            { name: 'O. Mylla', currentWeek: 9 },
            { name: 'S. Boyle', currentWeek: 10 },
            { name: 'L. Atrakimaviciene', currentWeek: 11 },
            { name: 'J. Haque', currentWeek: 12 },
            { name: 'R. Frimpong', currentWeek: 13 },
            { name: 'N. Tuck', currentWeek: 14 },
            { name: 'R. Forrester-Blackstock', currentWeek: 15 },
            { name: 'S. Langley', currentWeek: 16 },
            { name: 'S. Silva', currentWeek: 17 },
            { name: 'J. Sumaili', currentWeek: 18 },
            { name: 'T. Bibi', currentWeek: 19 },
            { name: 'T. Nsuala', currentWeek: 20 }
        ];

        // Calculate UK Bank Holidays for any year
        function calculateBankHolidays(year) {
            const holidays = [];
            
            // New Year's Day (or substitute if weekend)
            let newYear = new Date(year, 0, 1);
            if (newYear.getDay() === 0) { // Sunday
                holidays.push(new Date(year, 0, 2));
            } else if (newYear.getDay() === 6) { // Saturday
                holidays.push(new Date(year, 0, 3));
            } else {
                holidays.push(newYear);
            }
            
            // Easter calculation (Computus algorithm)
            const a = year % 19;
            const b = Math.floor(year / 100);
            const c = year % 100;
            const d = Math.floor(b / 4);
            const e = b % 4;
            const f = Math.floor((b + 8) / 25);
            const g = Math.floor((b - f + 1) / 3);
            const h = (19 * a + b - d - g + 15) % 30;
            const i = Math.floor(c / 4);
            const k = c % 4;
            const l = (32 + 2 * e + 2 * i - h - k) % 7;
            const m = Math.floor((a + 11 * h + 22 * l) / 451);
            const month = Math.floor((h + l - 7 * m + 114) / 31) - 1;
            const day = ((h + l - 7 * m + 114) % 31) + 1;
            const easter = new Date(year, month, day);
            
            // Good Friday (2 days before Easter)
            const goodFriday = new Date(easter);
            goodFriday.setDate(easter.getDate() - 2);
            holidays.push(goodFriday);
            
            // Easter Monday (1 day after Easter)
            const easterMonday = new Date(easter);
            easterMonday.setDate(easter.getDate() + 1);
            holidays.push(easterMonday);
            
            // Early May Bank Holiday (first Monday in May)
            const mayFirst = new Date(year, 4, 1);
            const mayFirstDay = mayFirst.getDay();
            const daysUntilMonday = mayFirstDay === 0 ? 1 : mayFirstDay === 1 ? 0 : 8 - mayFirstDay;
            holidays.push(new Date(year, 4, 1 + daysUntilMonday));
            
            // Spring Bank Holiday (last Monday in May)
            const mayLast = new Date(year, 5, 0);
            const mayLastDay = mayLast.getDay();
            // Days to go back: Sat=5, Fri=4, Thu=3, Wed=2, Tue=1, Mon=0, Sun=6
            const mayDaysBack = (mayLastDay + 6) % 7;
            holidays.push(new Date(year, 4, mayLast.getDate() - mayDaysBack));
            
            // Summer Bank Holiday (last Monday in August)
            const augLast = new Date(year, 8, 0); // 8, 0 = last day of August
            const augLastDay = augLast.getDay();
            const augDaysBack = (augLastDay + 6) % 7;
            holidays.push(new Date(year, 7, augLast.getDate() - augDaysBack));
            
            // Christmas Day (or substitute)
            let christmas = new Date(year, 11, 25);
            if (christmas.getDay() === 0) {
                holidays.push(new Date(year, 11, 27));
            } else if (christmas.getDay() === 6) {
                holidays.push(new Date(year, 11, 27));
            } else {
                holidays.push(christmas);
            }
            
            // Boxing Day (or substitute)
            let boxingDay = new Date(year, 11, 26);
            if (boxingDay.getDay() === 0) {
                holidays.push(new Date(year, 11, 28));
            } else if (boxingDay.getDay() === 6) {
                holidays.push(new Date(year, 11, 28));
            } else if (christmas.getDay() === 0) {
                holidays.push(new Date(year, 11, 28));
            } else {
                holidays.push(boxingDay);
            }
            
            return holidays;
        }

        // Cache for performance
        const bankHolidaysCache = {};
        function getBankHolidays(year) {
            if (!bankHolidaysCache[year]) {
                bankHolidaysCache[year] = calculateBankHolidays(year);
            }
            return bankHolidaysCache[year];
        }

        // Check if date is bank holiday
        function isBankHoliday(date) {
            const yearHolidays = getBankHolidays(date.getFullYear());
            return yearHolidays.some(holiday => 
                holiday.getDate() === date.getDate() &&
                holiday.getMonth() === date.getMonth() &&
                holiday.getFullYear() === date.getFullYear()
            );
        }

        // Check if date is a payday (every 4 weeks from Feb 13, 2026)
        function isPayday(date) {
            // Normalize both dates to noon to avoid DST issues
            const firstPayday = new Date(2026, 1, 13, 12, 0, 0);
            const checkDate = new Date(date.getFullYear(), date.getMonth(), date.getDate(), 12, 0, 0);
            
            const diffTime = checkDate - firstPayday;
            const diffDays = Math.round(diffTime / (1000 * 60 * 60 * 24));
            
            // Check if it's exactly divisible by 4 weeks (28 days)
            return diffDays >= 0 && diffDays % 28 === 0;
        }

        // 20-week rotating roster pattern from the PDF (correctly parsed)
        // SP weeks mean "Spare" - can be rostered ANY day, ANY shift during that week
        const weeklyRoster = {
            1: { sun: 'SPARE', mon: 'SPARE', tue: 'SPARE', wed: 'SPARE', thu: 'SPARE', fri: 'SPARE', sat: 'SPARE' },
            2: { sun: '14:30-23:25', mon: '15:15-23:55', tue: '15:15-23:55', wed: '15:15-23:55', thu: '15:15-23:55', fri: 'RD', sat: 'RD' },
            3: { sun: 'RD', mon: 'RD', tue: '06:20-14:20', wed: '06:20-14:20', thu: '06:20-14:20', fri: '06:20-14:20', sat: '06:20-14:00' },
            4: { sun: '07:15-15:45', mon: 'RD', tue: '06:20-14:20', wed: '06:20-14:20', thu: 'RD', fri: 'RD', sat: '14:45-23:55' },
            5: { sun: '14:30-23:25', mon: '14:00-22:30', tue: '14:00-22:30', wed: '14:00-22:30', thu: '14:00-22:30', fri: '15:15-23:55', sat: 'RD' },
            6: { sun: 'RD', mon: '06:20-14:20', tue: '08:00-16:30', wed: '08:00-16:30', thu: '08:00-16:30', fri: '08:00-16:30', sat: 'RD' },
            7: { sun: 'SPARE', mon: 'SPARE', tue: 'SPARE', wed: 'SPARE', thu: 'SPARE', fri: 'SPARE', sat: 'SPARE' },
            8: { sun: '07:15-15:45', mon: '06:20-13:45', tue: 'RD', wed: 'RD', thu: '13:30-22:00', fri: '14:00-22:30', sat: '13:30-21:00' },
            9: { sun: 'RD', mon: '11:00-19:30', tue: '11:00-19:30', wed: '11:00-19:30', thu: '11:00-19:30', fri: '11:00-19:30', sat: 'RD' },
            10: { sun: 'RD', mon: 'RD', tue: '15:15-23:55', wed: '15:15-23:55', thu: '15:15-23:55', fri: '15:15-23:55', sat: '14:45-23:55' },
            11: { sun: 'RD', mon: '08:00-16:30', tue: '13:30-22:00', wed: 'RD', thu: 'RD', fri: '06:20-13:35', sat: '06:20-14:50' },
            12: { sun: 'SPARE', mon: 'SPARE', tue: 'SPARE', wed: 'SPARE', thu: 'SPARE', fri: 'SPARE', sat: 'SPARE' },
            13: { sun: 'RD', mon: 'RD', tue: '14:00-22:30', wed: '14:00-22:30', thu: '14:00-22:30', fri: '14:00-22:30', sat: '14:30-22:00' },
            14: { sun: '14:30-23:25', mon: '14:00-22:30', tue: 'RD', wed: 'RD', thu: 'RD', fri: '08:00-16:30', sat: '06:20-14:50' },
            15: { sun: '07:15-15:45', mon: '06:20-13:35', tue: '06:20-13:35', wed: '06:20-13:35', thu: '06:20-13:35', fri: 'RD', sat: 'RD' },
            16: { sun: 'RD', mon: '08:00-16:30', tue: '08:00-16:30', wed: '08:00-16:30', thu: 'RD', fri: 'RD', sat: 'RD' },
            17: { sun: 'SPARE', mon: 'SPARE', tue: 'SPARE', wed: 'SPARE', thu: 'SPARE', fri: 'SPARE', sat: 'SPARE' },
            18: { sun: '13:00-21:00', mon: '15:15-23:55', tue: 'RD', wed: 'RD', thu: '06:20-14:20', fri: '06:20-14:20', sat: '06:20-14:50' },
            19: { sun: 'RD', mon: 'RD', tue: '06:20-13:45', wed: '06:20-13:45', thu: '06:20-13:45', fri: '06:20-13:45', sat: '12:00-20:00' },
            20: { sun: '08:30-16:30', mon: '06:20-14:20', tue: 'RD', wed: 'RD', thu: '08:00-16:30', fri: '13:30-22:00', sat: '14:30-22:00' }
        };

        const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
        const dayKeys = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'];
        const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 
                           'July', 'August', 'September', 'October', 'November', 'December'];
        
        // Current date: Get actual today's date
        const today = new Date();
        
        // Reference date for week calculations: Sunday Feb 8, 2026 is when team was on their assigned weeks
        const referenceDate = new Date(2026, 1, 8); // Sunday Feb 8, 2026
        
        let currentDisplayMonth = today.getMonth();
        let currentDisplayYear = today.getFullYear();

        // Get selected team member index (default to G. Miller - index 2)
        function getSelectedMemberIndex() {
            const saved = localStorage.getItem('selectedTeamMember');
            return saved !== null ? parseInt(saved) : 2; // Default to G. Miller (index 2)
        }

        // Save selected team member
        function saveSelectedMember(index) {
            localStorage.setItem('selectedTeamMember', index);
        }

        // Populate team member dropdown
        function populateTeamMemberDropdown() {
            const select = document.getElementById('teamMemberSelect');
            const selectedIndex = getSelectedMemberIndex();
            
            teamMembers.forEach((member, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = member.name;
                if (index === selectedIndex) {
                    option.selected = true;
                }
                select.appendChild(option);
            });
        }

        function getWeekNumberForDate(date) {
            // Each week runs Sunday to Saturday
            // Get the selected team member's current week
            const selectedIndex = getSelectedMemberIndex();
            const selectedMember = teamMembers[selectedIndex];
            const memberCurrentWeek = selectedMember.currentWeek;
            
            // Normalize all dates to midnight to avoid time issues
            const dateOnly = new Date(date.getFullYear(), date.getMonth(), date.getDate());
            const dayOfWeek = dateOnly.getDay(); // 0 = Sunday
            
            // Get the Sunday of the week containing this date
            const sundayOfWeek = new Date(dateOnly);
            sundayOfWeek.setDate(dateOnly.getDate() - dayOfWeek);
            
            // Reference: Feb 8, 2026 is when G. Miller is on Week 3
            const referenceSunday = new Date(2026, 1, 8, 0, 0, 0, 0);
            
            // Calculate how many full weeks have passed since the reference date
            const millisDiff = sundayOfWeek - referenceSunday;
            const daysDiff = Math.round(millisDiff / (1000 * 60 * 60 * 24));
            const weeksDiff = Math.floor(daysDiff / 7);
            
            // Calculate which week in the 20-week cycle for this team member
            let weekNum = memberCurrentWeek + weeksDiff;
            
            // Handle wrapping around the 20-week cycle
            while (weekNum < 1) weekNum += 20;
            while (weekNum > 20) weekNum -= 20;
            
            return weekNum;
        }

        function isEarlyShift(timeStr) {
            if (timeStr === 'RD') return false;
            const startTime = timeStr.split('-')[0];
            const hour = parseInt(startTime.split(':')[0]);
            return hour < 11;
        }

        function getShiftClass(timeStr) {
            if (timeStr === 'RD') return 'rest-day';
            if (timeStr === 'SPARE') return 'spare-day';
            return isEarlyShift(timeStr) ? 'early-shift' : 'late-shift';
        }

        function getShiftBadge(timeStr) {
            if (timeStr === 'RD') return '<span class="shift-badge badge-rest">üè† Rest</span>';
            if (timeStr === 'SPARE') return '<span class="shift-badge badge-spare">üìã Spare</span>';
            return isEarlyShift(timeStr) 
                ? '<span class="shift-badge badge-early">‚òÄÔ∏è Early</span>'
                : '<span class="shift-badge badge-late">üåô Late</span>';
        }

        function isSameDay(date1, date2) {
            return date1.getDate() === date2.getDate() &&
                   date1.getMonth() === date2.getMonth() &&
                   date1.getFullYear() === date2.getFullYear();
        }

        function renderCalendar() {
            const selectedIndex = getSelectedMemberIndex();
            const selectedMember = teamMembers[selectedIndex];
            
            // Set team member name on header for printing
            const headerElement = document.querySelector('.header');
            if (headerElement) {
                headerElement.setAttribute('data-member-name', selectedMember.name);
            }
            
            const calendarDisplay = document.getElementById('calendarDisplay');
            
            // Create calendar container
            const calendarContainer = document.createElement('div');
            calendarContainer.className = 'calendar-container';

            // Get first day of the month
            const firstDay = new Date(currentDisplayYear, currentDisplayMonth, 1);
            const lastDay = new Date(currentDisplayYear, currentDisplayMonth + 1, 0);
            
            // Get first week number of the month for display
            const firstDayOfMonth = new Date(currentDisplayYear, currentDisplayMonth, 1);
            const firstWeekNum = getWeekNumberForDate(firstDayOfMonth);
            
            // Calendar header
            const header = document.createElement('div');
            header.className = 'calendar-header';
            header.innerHTML = `
                <div class="month-year">${monthNames[currentDisplayMonth]} ${currentDisplayYear}</div>
                <div class="week-info">Starting at Week ${firstWeekNum}</div>
            `;
            calendarContainer.appendChild(header);

            // Calendar grid
            const grid = document.createElement('div');
            grid.className = 'calendar-grid';

            // Add day headers
            dayNames.forEach(day => {
                const dayHeader = document.createElement('div');
                dayHeader.className = 'day-header';
                dayHeader.textContent = day;
                grid.appendChild(dayHeader);
            });

            // Get starting day of week (0 = Sunday)
            const startDay = firstDay.getDay();

            // Add empty cells for days before the month starts
            for (let i = 0; i < startDay; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.className = 'calendar-day other-month';
                
                const prevMonthLastDay = new Date(currentDisplayYear, currentDisplayMonth, 0);
                const dayNum = prevMonthLastDay.getDate() - startDay + i + 1;
                emptyDay.innerHTML = `<div class="day-number">${dayNum}</div>`;
                grid.appendChild(emptyDay);
            }

            // Add days of the month
            const daysInMonth = lastDay.getDate();
            for (let day = 1; day <= daysInMonth; day++) {
                const currentDate = new Date(currentDisplayYear, currentDisplayMonth, day);
                const dayOfWeek = currentDate.getDay();
                const weekNum = getWeekNumberForDate(currentDate);
                const dayKey = dayKeys[dayOfWeek];
                const shift = weeklyRoster[weekNum][dayKey];

                const dayCell = document.createElement('div');
                dayCell.className = `calendar-day ${getShiftClass(shift)}`;
                
                if (isSameDay(currentDate, today)) {
                    dayCell.classList.add('today');
                }

                if (isBankHoliday(currentDate)) {
                    dayCell.classList.add('bank-holiday');
                }

                if (isPayday(currentDate)) {
                    dayCell.classList.add('payday');
                }

                dayCell.innerHTML = `
                    <div class="day-number">${day}</div>
                    ${getShiftBadge(shift)}
                    ${shift !== 'RD' && shift !== 'SPARE' ? `<div class="shift-time">${shift}</div>` : ''}
                `;

                grid.appendChild(dayCell);
            }

            // Add remaining cells to complete the grid
            const totalCells = startDay + daysInMonth;
            const remainingCells = totalCells % 7 === 0 ? 0 : 7 - (totalCells % 7);
            
            for (let i = 1; i <= remainingCells; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.className = 'calendar-day other-month';
                emptyDay.innerHTML = `<div class="day-number">${i}</div>`;
                grid.appendChild(emptyDay);
            }

            calendarContainer.appendChild(grid);
            calendarDisplay.innerHTML = '';
            calendarDisplay.appendChild(calendarContainer);
        }

        // Event listeners
        document.getElementById('teamMemberSelect').addEventListener('change', (e) => {
            saveSelectedMember(parseInt(e.target.value));
            renderCalendar();
        });
        
        document.getElementById('prevMonth').addEventListener('click', () => {
            currentDisplayMonth--;
            if (currentDisplayMonth < 0) {
                currentDisplayMonth = 11;
                currentDisplayYear--;
            }
            renderCalendar();
        });

        document.getElementById('todayBtn').addEventListener('click', () => {
            currentDisplayMonth = today.getMonth();
            currentDisplayYear = today.getFullYear();
            renderCalendar();
        });

        document.getElementById('nextMonth').addEventListener('click', () => {
            currentDisplayMonth++;
            if (currentDisplayMonth > 11) {
                currentDisplayMonth = 0;
                currentDisplayYear++;
            }
            renderCalendar();
        });

        document.getElementById('printBtn').addEventListener('click', () => {
            window.print();
        });

        // Initialize
        populateTeamMemberDropdown();
        renderCalendar();

        // Register service worker for PWA functionality
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js')
                    .then(registration => {
                        console.log('Service Worker registered successfully:', registration.scope);
                    })
                    .catch(error => {
                        console.log('Service Worker registration failed:', error);
                    });
            });
        }
    </script>
</body>
</html>
